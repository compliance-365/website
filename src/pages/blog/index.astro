---
import Base from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';

const base = import.meta.env.BASE_URL || '/';
// Load all posts (newest first)
const posts = (await Astro.glob('../../content/blog/*.md'))
  .sort((a,b) => new Date(b.frontmatter.date || 0).getTime() - new Date(a.frontmatter.date || 0).getTime());

function coverUrl(img?: string) {
  if (!img) return null;
  if (/^https?:\/\//i.test(img)) return img;
  return `${base}${String(img).replace(/^\//,'')}`;
}
---
<Base title="Insights — Compliance365" description="Thought leadership on ISO, privacy and AI governance.">
  <Header />

  <section class="container section">
    <h1>Insights</h1>
    <p class="muted" style="max-width:760px">
      Practical guidance on ISO 27001, ISO 27701, ISO 42001 and Essential Eight — with a focus on audit-ready evidence in Microsoft 365.
    </p>

    <div class="grid-3" style="margin-top:16px">
      {posts.map((post) => {
        const filename = post.file.split('/').pop() || '';
        const slug = filename.replace(/\.md$/i, '');
        const href = `${base}blog/${slug}`;
        const img  = coverUrl(post.frontmatter.image);
        return (
          <article class="card lift" style="overflow:hidden; display:flex; flex-direction:column;">
            {img && (
              <a href={href} style="display:block; border-radius:12px; overflow:hidden;">
                <img
                  src={img}
                  alt={post.frontmatter.title}
                  loading="lazy"
                  style="width:100%; aspect-ratio: 16/9; object-fit:cover; border:1px solid rgba(10,18,32,.06); border-radius:12px;"
                />
              </a>
            )}
            <div style="padding-top:12px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
              {post.frontmatter.tags && post.frontmatter.tags.slice(0,2).map((t) => (
                <span class="pill">{t}</span>
              ))}
            </div>
            <h3 style="margin:.6rem 0 .2rem">
              <a href={href} style="color:inherit; text-decoration:none">{post.frontmatter.title}</a>
            </h3>
            <p class="muted" style="margin:0 0 10px">{post.frontmatter.description}</p>
            <div style="margin-top:auto; display:flex; justify-content:space-between; align-items:center;">
              <span class="small muted">
                {post.frontmatter.date ? new Date(post.frontmatter.date).toLocaleDateString() : ''}
              </span>
              <a class="pill" href={href}>Read post →</a>
            </div>
          </article>
        );
      })}
    </div>
  </section>

  <Footer />
</Base>
