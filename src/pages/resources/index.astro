---
import Base from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';

const base = import.meta.env.BASE_URL || '/';

// CHANGE THIS to your Formspree endpoint id
const FORMSPREE = 'https://formspree.io/f/yourFormId';
---

<Base title="Resources — Compliance365"
      description="Free checklists, guides and templates for ISO 27001, ISO 27701 and ISO 42001.">
  <Header />

  <section class="container section">
    <h1>Resources</h1>
    <p class="muted" style="max-width:760px">
      Practical tools to help you move faster—no fluff. Checklists now, whitepapers and webinar replays coming soon.
    </p>

    <div class="grid-3" style="margin-top:16px">
      <!-- ISO 27001 -->
      <article class="card lift" style="display:flex;flex-direction:column;gap:10px">
        <img src={`${base}assets/blog-iso27001-v3.svg`} alt="" style="width:100%;border-radius:12px;border:1px solid rgba(10,18,32,.06)"/>
        <h3 style="margin:.4rem 0 0">ISO 27001 Readiness Checklist</h3>
        <p class="muted">10-point scorecard for scope, risk, controls, SoA and internal audit.</p>
        <div style="margin-top:auto;display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn btn-primary dl" data-target={`${base}checklist/iso27001`} type="button">Start checklist</button>
        </div>
      </article>

      <!-- ISO 27701 -->
      <article class="card lift" style="display:flex;flex-direction:column;gap:10px">
        <img src={`${base}assets/blog-iso27701-v3.svg`} alt="" style="width:100%;border-radius:12px;border:1px solid rgba(10,18,32,.06)"/>
        <h3 style="margin:.4rem 0 0">ISO 27701 (Privacy) Checklist</h3>
        <p class="muted">ROPA, DPIA, rights handling, data lifecycle, privacy controls.</p>
        <div style="margin-top:auto;display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn btn-primary dl" data-target={`${base}checklist/iso27701`} type="button">Start checklist</button>
        </div>
      </article>

      <!-- ISO 42001 -->
      <article class="card lift" style="display:flex;flex-direction:column;gap:10px">
        <img src={`${base}assets/blog-iso42001-v3.svg`} alt="" style="width:100%;border-radius:12px;border:1px solid rgba(10,18,32,.06)"/>
        <h3 style="margin:.4rem 0 0">ISO 42001 (AI) Checklist</h3>
        <p class="muted">AIMS governance, model inventory, AI risk, human oversight and monitoring.</p>
        <div style="margin-top:auto;display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn btn-primary dl" data-target={`${base}checklist/iso42001`} type="button">Start checklist</button>
        </div>
      </article>
    </div>
  </section>

  <Footer />

  <!-- Lead modal (shared across all downloads) -->
  <div id="leadModal" role="dialog" aria-modal="true" aria-labelledby="leadTitle"
       style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.45);
              align-items:center; justify-content:center; z-index:2500;">
    <div style="background:#fff; padding:22px; border-radius:16px; width:min(94vw,460px);
                box-shadow:0 16px 40px rgba(0,0,0,.18); border:1px solid rgba(10,18,32,.08)">
      <h3 id="leadTitle" style="margin:0 0 6px">Before you continue</h3>
      <p class="muted small" style="margin-top:0">Tell us where to send the checklist and related resources.</p>

      <form id="leadForm" novalidate>
        <label class="small" for="name">Name</label>
        <input id="name" name="name" type="text" autocomplete="name"
               style="width:100%;margin:6px 0 10px;padding:12px;border:1px solid #d8dde8;border-radius:10px" required>

        <label class="small" for="email">Work email</label>
        <input id="email" name="email" type="email" autocomplete="email"
               style="width:100%;margin:6px 0 2px;padding:12px;border:1px solid #d8dde8;border-radius:10px" required>

        <p id="leadError" class="small" style="color:#b91c1c;display:none;margin:.25rem 0 0"></p>

        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:14px">
          <button type="button" class="btn btn-ghost" id="leadCancel">Cancel</button>
          <button type="submit" class="btn btn-primary" id="leadSubmit">Continue</button>
        </div>
      </form>
    </div>
  </div>

  <script is:inline>
    const FORMSPREE = "{FORMSPREE}"; // injected from frontmatter above
    let pendingTarget = null;

    const modal = document.getElementById('leadModal');
    const form  = document.getElementById('leadForm');
    const err   = document.getElementById('leadError');
    const cancel= document.getElementById('leadCancel');
    const submitBtn = document.getElementById('leadSubmit');

    // Open modal when a .dl button is clicked
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('button.dl');
      if(!btn) return;
      pendingTarget = btn.dataset.target;
      err.style.display = 'none';
      form.reset();
      modal.style.display = 'flex';
      setTimeout(()=> document.getElementById('name').focus(), 0);
    });

    // Close modal
    const close = ()=> { modal.style.display = 'none'; pendingTarget = null; };
    cancel.addEventListener('click', close);
    modal.addEventListener('click', (e)=>{ if(e.target === modal) close(); });
    document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') close(); });

    // Validate
    function validEmail(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v); }

    // Submit to Formspree then redirect
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      err.style.display = 'none';

      const name  = (document.getElementById('name').value || '').trim();
      const email = (document.getElementById('email').value || '').trim();

      if(!name || !validEmail(email)){
        err.textContent = 'Please enter your name and a valid email.';
        err.style.display = 'block';
        return;
      }
      if(!pendingTarget){ close(); return; }

      submitBtn.disabled = true;

      try{
        const res = await fetch(FORMSPREE, {
          method: 'POST',
          headers: { 'Accept': 'application/json', 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, email, source: 'resources', intent: 'checklist', target: pendingTarget })
        });

        // Best-effort; even if Formspree blocks, still let them through.
        close();
        window.location.href = pendingTarget;
      }catch{
        close();
        window.location.href = pendingTarget;
      }finally{
        submitBtn.disabled = false;
      }
    });
  </script>
</Base>
