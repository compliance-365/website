---
import Base from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
const base = import.meta.env.BASE_URL || '/';
const STANDARD = 'ISO 27701';
const QUESTIONS = [
  { id:'pims', label:'PIMS scope & roles defined (controllers/processors)?' },
  { id:'dpia', label:'DPIA process operating for high-risk processing?' },
  { id:'ropa', label:'ROPA maintained and reviewed?' },
  { id:'rights', label:'Subject rights workflow (access/erasure/etc.) in place?' },
  { id:'govern', label:'Retention, labels and DLP enforced in M365 (Purview)?' },
  { id:'audit', label:'Internal audit and management review complete?' }
];
---
<Base title="ISO 27701 Readiness Checklist" description="Quick privacy readiness check with score & PDF.">
  <Header />
  <section class="container section">
    <h1>{STANDARD} Readiness Checklist</h1>
    <div class="progress"><div id="bar" style="width:0%"></div></div>

    <div class="check-tabs" style="margin-top:12px">
      <a href={`${base}checklist/iso27001`}>ISO 27001</a>
      <a href={`${base}checklist/iso27701`} class="active">ISO 27701</a>
      <a href={`${base}checklist/iso42001`}>ISO 42001</a>
    </div>

    <div class="card">
      <div class="form-grid" id="form"></div>
      <div class="actions">
        <button class="btn btn-ghost" id="resetBtn">Reset</button>
        <button class="btn btn-primary" id="pdfBtn">Download PDF</button>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <div class="scorecard">
        <div class="score" id="scoreNum">0%</div>
        <div>
          <strong id="scoreLabel">Not started</strong>
          <p class="muted small" id="scoreHint">Answer the questions to see your readiness.</p>
        </div>
      </div>
    </div>
  </section>
  <Footer />

  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" defer></script>
  <script is:inline>
    const STANDARD = {STANDARD};
    const QUESTIONS = {JSON.stringify(QUESTIONS)};
    const form = document.getElementById('form');
    const bar  = document.getElementById('bar');
    const scoreNum = document.getElementById('scoreNum');
    const scoreLabel = document.getElementById('scoreLabel');
    const scoreHint  = document.getElementById('scoreHint');
    const state = Object.fromEntries(QUESTIONS.map(q => [q.id, null]));

    function paint(){ form.innerHTML=''; QUESTIONS.forEach((q,i)=>{ const d=document.createElement('div'); d.className='field'; d.innerHTML=`
      <label>${i+1}. ${q.label}</label>
      <div class="opts">
        <button class="opt" data-id="${q.id}" data-v="2">Yes</button>
        <button class="opt" data-id="${q.id}" data-v="1">Partial</button>
        <button class="opt" data-id="${q.id}" data-v="0">No</button>
      </div>`; form.appendChild(d); }); 
      form.onclick=(e)=>{ const b=e.target.closest('.opt'); if(!b) return; state[b.dataset.id]=Number(b.dataset.v); b.parentElement.querySelectorAll('.opt').forEach(o=>o.classList.remove('active')); b.classList.add('active'); update(); };
    }
    function update(){ const ans=Object.values(state).filter(v=>v!==null).length; bar.style.width=Math.round(ans/QUESTIONS.length*100)+'%';
      const raw=Object.values(state).reduce((a,v)=>a+(v??0),0); const max=QUESTIONS.length*2; const s=Math.round(raw/max*100)||0;
      scoreNum.textContent=s+'%'; let l='Not started',h='Answer the questions to see your readiness.'; if(ans>0&&s<40){l='Early stage';h='Stand up PIMS basics and DPIA process.';} else if(s<70){l='In progress';h='Tighten ROPA, rights handling and Purview controls.';} else if(s<90){l='Nearly ready';h='Close gaps, collect evidence and plan audit.';} else {l='Audit-ready';h='Looks ready. Lock audit dates.';} scoreLabel.textContent=l; scoreHint.textContent=h; }
    document.getElementById('resetBtn').onclick=()=>{Object.keys(state).forEach(k=>state[k]=null); paint(); update();};
    document.getElementById('pdfBtn').onclick=()=>{ const {jsPDF}=window.jspdf; const doc=new jsPDF(); let y=14; doc.setFont('helvetica','bold');doc.setFontSize(16); doc.text(`${STANDARD} Readiness Summary`,14,y); y+=8; doc.setFont('helvetica','normal');doc.setFontSize(11);
      const ans=Object.values(state).filter(v=>v!==null).length; const raw=Object.values(state).reduce((a,v)=>a+(v??0),0); const max=QUESTIONS.length*2; const s=Math.round(raw/max*100)||0;
      doc.text(`Score: ${s}% • Answered ${ans}/${QUESTIONS.length}`,14,y); y+=8;
      QUESTIONS.forEach((q,i)=>{ const v=state[q.id]; const lbl=v===2?'Yes':v===1?'Partial':v===0?'No':'—'; if(y>270){doc.addPage(); y=14;} doc.text(`${i+1}. ${q.label} — ${lbl}`,14,y); y+=7; });
      doc.save(`${STANDARD.replace(/\s+/g,'_').toLowerCase()}_readiness.pdf`);
    };
    paint(); update();
  </script>
</Base>
